name: Generate MCP Server

on:
  push:
    branches: [main]
    paths:
      - "source_specs/**"
  workflow_dispatch:

concurrency:
  group: mcp-generation
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  generate-mcp:
    name: Generate MCP Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout spec repo
        uses: actions/checkout@v4
        with:
          path: spec-repo

      - name: Checkout MCP repo
        uses: actions/checkout@v4
        with:
          repository: pipeshub-ai/mcp-server
          token: ${{ secrets.GH_TOKEN }}
          path: mcp-repo
          ref: main

      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
          echo "$HOME/.speakeasy/bin" >> "$GITHUB_PATH"
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}

      - name: Clean generated src before regeneration
        working-directory: mcp-repo
        run: |
          if [ -d "src" ]; then
            rm -rf src
          fi

      - name: Generate MCP Server
        run: |
          speakeasy generate sdk \
            -s spec-repo/source_specs/pipeshub-openapi.yaml \
            -l mcp-typescript \
            -o mcp-repo
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}

      - name: Check for changes
        id: changes
        working-directory: mcp-repo
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get spec commit info
        if: steps.changes.outputs.has_changes == 'true'
        id: spec_info
        working-directory: spec-repo
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "sha_full=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "commit_msg=$(git log -1 --pretty=format:'%s')" >> "$GITHUB_OUTPUT"

      - name: Create pull request in MCP repo
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: mcp-repo
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          BRANCH="auto/mcp-update-${{ steps.spec_info.outputs.sha_short }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -B "$BRANCH"
          git add -A
          git commit -m "$(cat <<'EOF'
          chore: regenerate MCP server from OpenAPI spec update

          Spec commit: ${{ steps.spec_info.outputs.sha_short }}
          Spec change: ${{ steps.spec_info.outputs.commit_msg }}
          EOF
          )"
          git push --force-with-lease origin "$BRANCH"

          EXISTING_PR=$(gh pr list \
            --repo "pipeshub-ai/mcp-server" \
            --head "$BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH — updated via force push."
          else
            gh pr create \
              --repo "pipeshub-ai/mcp-server" \
              --base main \
              --head "$BRANCH" \
              --title "chore: update MCP server from OpenAPI spec (${{ steps.spec_info.outputs.sha_short }})" \
              --body "$(cat <<'PREOF'
          ## Auto-generated MCP Server Update

          This PR was automatically created by the [OpenAPI spec repo](https://github.com/pipeshub-ai/open-api) when the spec was updated.

          **Spec commit:** [`${{ steps.spec_info.outputs.sha_short }}`](https://github.com/pipeshub-ai/open-api/commit/${{ steps.spec_info.outputs.sha_full }})
          **Spec change:** ${{ steps.spec_info.outputs.commit_msg }}
          **Workflow run:** [View run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          > Please review the generated changes before merging.
          PREOF
              )"
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "### MCP Server" >> "$GITHUB_STEP_SUMMARY"
            echo "Changes detected — PR created/updated in \`pipeshub-ai/mcp-server\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### MCP Server" >> "$GITHUB_STEP_SUMMARY"
            echo "No changes detected — nothing to do." >> "$GITHUB_STEP_SUMMARY"
          fi
